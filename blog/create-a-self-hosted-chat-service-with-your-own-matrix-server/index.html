<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Victoria Drake, Director of Engineering, is building better cybersecurity and happy and productive technical teams."><title>Create a self-hosted chat service with your own Matrix server | victoria.dev</title><link href=https://github.com/victoriadrake rel=me><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=webmention href=https://webmention.io/victoria.dev/webmention><link rel=pingback href=https://webmention.io/victoria.dev/xmlrpc><link rel=feed href=https://victoria.dev/neofeed><script async defer data-domain=victoria.dev src=https://p.victoria.dev/js/index.js></script><meta name=monetization content="$ilp.uphold.com/pBRfRwg2EJAe"><meta property="og:title" content="Create a self-hosted chat service with your own Matrix server - victoria.dev"><meta property="og:type" content="website"><meta property="og:description" content="A speed-run introduction to Matrix via Dendrite."><meta property="og:url" content="https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/"><meta property="og:site_name" content="victoria.dev"><meta property="og:image" content="https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/lightsail_443.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Create a self-hosted chat service with your own Matrix server"><meta name=twitter:image content="https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/lightsail_443.png"><meta name=twitter:description content="A speed-run introduction to Matrix via Dendrite."><link rel="shortcut icon" href=/img/favicon.ico><link rel=stylesheet href=/css/main.min.bf0b14c7fdf7ff788f6d5c31eb1014f424eb4a8b9743660cd92cb82e4b48e6cc.css integrity="sha256-vwsUx/33/3iPbVwx6xAU9CTrSouXQ2YM2Sy4LktI5sw=" media=screen></head><body><header role=banner><nav aria-label="Victoria.dev main menu" id=menu><ul role=menubar><li role=none class=menu-item><a role=menuitem href=/><img src=/img/bookmark.svg alt="home page icon" height=18px class=filter-icon> hi</a></li><li role=none class=menu-item><a role=menuitem href=/blog/><img src=/img/quote.svg alt="blog icon" height=18px class=filter-icon> blog</a></li><li role=none class=menu-item><a role=menuitem href=/about/><img src=/img/profile.svg alt="about page icon" height=18px class=filter-icon> about</a></li><li role=none class=menu-item><a role=menuitem href=/coffee/><img src=/img/coffee.svg alt="coffee icon" height=18px class=filter-icon> buy me coffee</a></li><li role=none class=menu-item><a role=menuitem href=/bookshelf/><img src=/img/book.svg alt="bookshelf icon" height=18px class=filter-icon> bookshelf</a></li><li role=none class=menu-item><a role=menuitem id=rss href=https://victoria.dev/index.xml rel=alternate type=application/rss+xml title="RSS for Create a self-hosted chat service with your own Matrix server"><img src=/img/rss.svg alt="RSS icon" height=18px class=filter-icon> rss</a></li></ul></nav></header><main aria-role=main><div class=container><article class=h-entry><h1 class=title-header>Create a self-hosted chat service with your own Matrix server</h1><p class=subtitle>A speed-run introduction to Matrix via Dendrite.</p><span><a class="tag button" href=/tags/privacy/>privacy
</a>&nbsp;
<a class="tag button" href=/tags/protocols/>protocols
</a>&nbsp;
<a class="tag button" href=/tags/linux/>linux
</a>&nbsp;
<a class="tag button" href=/tags/aws/>aws
</a>&nbsp;
<a class="tag button" href=/tags/go/>go
</a>&nbsp;
<a class="tag button" href=/tags/terminal/>terminal
</a>&nbsp;</span><p class=metadata id=date><time><a class="u-url dt-published" href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/>February 15, 2021</a></time>
<span class=dt-updated>&nbsp;
<em>Updated: May 12, 2021</em></span>
<span>☕️ ☕️&nbsp;6 min read</span></p></p><div class=page-separator><hr></div><div class="markdown e-content"><p><a href=https://matrix.org/docs/guides/introduction>Matrix</a> is an open standard for decentralized real-time communication. The <a href=https://matrix.org/docs/spec/>specification</a> is production-ready and <a href=https://matrix.org/bridges/>bridges</a> to tons of silo products like Slack, Gitter, Telegram, Discord, and even Facebook Messenger. This lets you use Matrix to link together disjoint communities in one place, or create an alternative communication method that works with, but is independent of, communication silos.</p><p>You can create your own self-hosted Matrix chat for as little as $3.50 USD per month on an <a href=https://aws.amazon.com/lightsail/>AWS Lightsail</a> instance. Your homeserver can federate with other Matrix servers, giving you a reliable and fault-tolerant means of communication.</p><p>Matrix is most widely installed via its <a href=https://matrix.org/docs/guides/installing-synapse>Synapse</a> homeserver implementation written in Python 3. Dendrite, its second-generation homeserver implementation written in Go, is currently released in beta. Dendrite will provide more memory efficiency and reliability out-of-the-box, making it an excellent choice for running on a virtual instance.</p><p>Here&rsquo;s how to set up your own homeserver on AWS Lightsail with Dendrite. You can also <a href=https://github.com/matrix-org/dendrite>contribute to Dendrite today</a>.</p><h2 id=create-a-lightsail-instance class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#create-a-lightsail-instance>Create a Lightsail instance</a></h2><p>Spin up a new Lightsail instance on AWS with Debian as your operating system. It&rsquo;s a good idea to create a new per-instance key for use with SSH. You can do this by with the SSH key pair manager on the instance creation page. Don&rsquo;t forget to download your private key and <code>.gitignore</code> your secrets.</p><p>Click <strong>Create Instance.</strong> Wait for the status of your instance to change from <strong>Pending</strong> to <strong>Running</strong>, then click its name to see further information. You&rsquo;ll need the Public IP address.</p><p>To enable people including yourself to connect to the instance, go to the Networking tab and add a firewall rule for HTTPS. This will open <code>443</code> so you can connect over IPv4. You can also do this for IPv6.</p><h2 id=connect-dns class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#connect-dns>Connect DNS</a></h2><p>Give your instance a catchier address by <a href=https://www.jdoqocy.com/ds70r09608OQPPRVXSQPOQSRVVVVX target=_top>buying a domain at Namecheap</a>
and setting up DNS records.</p><ol><li>On your domain management page in the <strong>Nameservers</strong> section, choose <strong>Namecheap BasicDNS</strong>.</li><li>On the <strong>Advanced DNS</strong> tab, click <strong>Add New Record</strong>.</li></ol><p>Add an <code>A Record</code> to your Lightsail Public IP. You can use a subdomain if you want one, for example,</p><ul><li><strong>Type:</strong> <code>A Record</code></li><li><strong>Host:</strong> <code>matrix</code></li><li><strong>Value:</strong> <code>13.59.251.229</code></li></ul><p>This points <code>matrix.example.org</code> to your Lightsail instance.</p><h2 id=set-up-your-matrix-homeserver class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#set-up-your-matrix-homeserver>Set up your Matrix homeserver</a></h2><p>Change permissions on the private key you downloaded:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>chmod <span class=m>600</span> &lt;path/to/key&gt;
</code></pre></div><p>Then <a href=https://lightsail.aws.amazon.com/ls/docs/en_us/articles/amazon-lightsail-ssh-using-terminal>SSH to your Public IP</a>:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>ssh -i &lt;path/to/key&gt; admin@&lt;public ip&gt;
</code></pre></div><p>Welcome to your instance! You can make it more interesting by downloading some packages you&rsquo;ll need for Dendrite. It&rsquo;s a good idea ot use <code>apt</code> for this, but first you&rsquo;ll want to make sure you&rsquo;re getting the latest stuff.</p><p>Change your <a href=https://wiki.debian.org/SourcesList>sources list</a> in order to get the newest version of Go:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo vim /etc/apt/sources.list
</code></pre></div><p>Delete everything except these two lines:</p><div class=highlight><pre class=chroma><code class=language-vim data-lang=vim><span class=nx>deb</span> <span class=nx>http</span>:<span class=sr>//</span><span class=nx>cdn</span><span class=p>-</span><span class=nx>aws</span>.<span class=nx>deb</span>.<span class=nx>debian</span>.<span class=nx>org</span>/<span class=nx>debian</span> <span class=nx>buster</span> <span class=nx>main</span><span class=err>
</span><span class=err></span><span class=nx>deb</span><span class=p>-</span><span class=nx>src</span> <span class=nx>http</span>:<span class=sr>//</span><span class=nx>cdn</span><span class=p>-</span><span class=nx>aws</span>.<span class=nx>deb</span>.<span class=nx>debian</span>.<span class=nx>org</span>/<span class=nx>debian</span> <span class=nx>buster</span> <span class=nx>main</span><span class=err>
</span></code></pre></div><p>Then replace the distributions:</p><div class=highlight><pre class=chroma><code class=language-vim data-lang=vim><span class=p>:</span>%<span class=nx>s</span><span class=sr>/buster main/</span><span class=nx>testing</span> <span class=nx>main</span> <span class=nx>contrib</span> <span class=nx>non</span><span class=p>-</span><span class=nx>free</span>/<span class=nx>g</span><span class=err>
</span></code></pre></div><p>Run <code>sudo apt dist-upgrade</code>. If you&rsquo;re asked about modified configuration files, choose the option to &ldquo;keep the local version currently installed.&rdquo;</p><p>Once the upgrade is finished, restart your instance with <code>sudo shutdown -r now</code>.</p><p>Go make some coffee, then SSH back in. Get the packages you&rsquo;ll need with:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo apt update
sudo apt upgrade
sudo apt install -y git golang nginx python3-certbot-nginx
</code></pre></div><p>You&rsquo;re ready to get Dendrite.</p><h2 id=get-dendrite class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#get-dendrite>Get Dendrite</a></h2><p>Clone <a href=https://github.com/matrix-org/dendrite>Dendrite</a> and follow the <a href=https://github.com/matrix-org/dendrite#get-started>README instructions to get started</a>. You&rsquo;ll need to choose whether you want your Matrix instance to be federating. For simplicity, here&rsquo;s how to set up a non-federating deployment to start:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>git clone https://github.com/matrix-org/dendrite
<span class=nb>cd</span> dendrite
./build.sh

<span class=c1># Generate a Matrix signing key for federation (required)</span>
./bin/generate-keys --private-key matrix_key.pem

<span class=c1># Generate a self-signed certificate (optional, but a valid TLS certificate is normally</span>
<span class=c1># needed for Matrix federation/clients to work properly!)</span>
./bin/generate-keys --tls-cert server.crt --tls-key server.key

<span class=c1># Copy and modify the config file - you&#39;ll need to set a server name and paths to the keys</span>
<span class=c1># at the very least, along with setting up the database connection strings.</span>
cp dendrite-config.yaml dendrite.yaml
</code></pre></div><h2 id=configure-dendrite class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#configure-dendrite>Configure Dendrite</a></h2><p>Modify the configuration file you just copied:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo vim dendrite.yaml
</code></pre></div><p>At minimum, set:</p><ul><li><code>server name</code> to your shiny new domain name, e.g. <code>matrix.example.org</code></li><li><code>disable_federation</code> to true or false</li><li><code>registration_disabled</code> to true or false</li></ul><p>You might like to read the <a href=https://github.com/matrix-org/dendrite/blob/master/docs/FAQ.md>Dendrite FAQ</a>.</p><h2 id=configure-nginx class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#configure-nginx>Configure nginx</a></h2><p>Get the required packages if you didn&rsquo;t already install them above:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo apt install nginx python3-certbot-nginx
</code></pre></div><p>Create your site&rsquo;s configuration file under <code>sites-available</code> with:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> /etc/nginx/sites-available
ln -s /etc/nginx/sites-available/&lt;sitename&gt; /etc/nginx/sites-enabled/&lt;sitename&gt;
sudo cp default &lt;sitename&gt;
</code></pre></div><p>Edit your site configuration. Delete the <code>root</code> and <code>index</code> lines if you don&rsquo;t need them, and input your server name.</p><p>Your <code>location</code> block should look like:</p><div class=highlight><pre class=chroma><code class=language-nginx data-lang=nginx><span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
    <span class=kn>proxy_pass</span> <span class=s>https://localhost:8448</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Remove the <code>default</code> with: <code>sudo rm /etc/nginx/sites-enabled/default</code>.</p><h2 id=create-self-signed-certificates class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#create-self-signed-certificates>Create self-signed certificates</a></h2><p>You can use <a href=https://certbot.eff.org/>Certbot</a> to generate self-signed certificates with <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a>.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo certbot --nginx -d &lt;your.site.address&gt;
</code></pre></div><p>If you don&rsquo;t want to give an email, add the <code>--register-unsafely-without-email</code> flag.</p><p>Test your configuration and restart nginx with:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo nginx -t
sudo systemctl restart nginx
</code></pre></div><p>Then start up your Matrix server.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Build and run the server:</span>
./bin/dendrite-monolith-server --tls-cert server.crt --tls-key server.key --config dendrite.yaml
</code></pre></div><p>Your Matrix server is up and running at your web address! If you disabled registration in your configuration, you may need to create a user. You can do this by running the included <code>dendrite/bin/createuser</code>.</p><p>You can log on to your new homeserver with any <a href=https://matrix.org/clients/>Matrix client</a>, or Matrix-capable applications like <a href="https://www.pidgin.im/plugins/?publisher=all&query=&type=">Pidgin with the Matrix plugin</a>.</p><h2 id=other-troubleshooting class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#other-troubleshooting>Other troubleshooting</a></h2><h3 id=log-files class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#log-files>Log files</a></h3><p>If you get an error such as:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>... [github.com/matrix-org/dendrite/internal/log.go:155] setupFileHook
  Couldn&#39;t create directory /var/log/dendrite: &#34;mkdir /var/log/dendrite: permission denied&#34;
</code></pre></div><p>You&rsquo;ll need to create a spot for your log files. Avoid the bad practice of running stuff with <code>sudo</code> whenever you can. Instead, create the necessary file with the right permissions:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>sudo mkdir /var/log/dendrite
sudo chown admin:admin /var/log/dendrite

<span class=c1># Build and run the server:</span>
./bin/dendrite-monolith-server --tls-cert server.crt --tls-key server.key --config dendrite.yaml
</code></pre></div><h3 id=unable-to-decrypt class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#unable-to-decrypt>Unable to decrypt</a></h3><p>If you see: <code>Unable to decrypt: The sender's device has not sent us the keys for this message.</code> you may need to verify a user (sometimes yourself).</p><ol><li>In your client, open the user&rsquo;s profile. Click the lock icon if there is one, or otherwise look for a way to verify them.</li><li>You may be asked to see if some emojis presented to both users match if you&rsquo;re using certain clients like Element.</li><li>You can then re-request encryption keys for any sent messages.</li></ol><h2 id=set-up-your-own-matrix-server-today class=anchor-link><a href=https://victoria.dev/blog/create-a-self-hosted-chat-service-with-your-own-matrix-server/#set-up-your-own-matrix-server-today>Set up your own Matrix server today</a></h2><p>I hope you found this introduction to setting up your own Matrix homeserver to be helpful! If you have anything to add, feel free to <a href=/blog/make-your-own-independent-website/>reply via Webmention</a>.</p></div><a class=hidden href=https://brid.gy/publish/twitter></a><a class=hidden href=https://brid.gy/publish/mastodon></a><data class=p-bridgy-omit-link value=false></data></article><div id=up-container><a href=# id=up>&#709;</a></div><div class=page-separator><hr></div><div id=webmentions></div><div class=related><code class=language-sql data-lang=sql>SELECT TOP 3 * FROM Related;</code><ul role=menubar id=article-list><li role=none class=h-entry><p class="p-author h-card hidden">Victoria Drake</p><img class="u-photo hidden" alt="photo of the author" id=author-img src=/img/victoria_headshot.jpg>
<a role=menuitem class="article-link u-url p-name" href=https://victoria.dev/blog/build-your-own-serverless-subscriber-list-with-go-and-aws/>Build your own serverless subscriber list with Go and AWS</a><p class=e-content>How to build your own newsletter list with DynamoDB and SES email sign up confirmations.</p><p class=metadata><a class="tag button" href=/tags/api/>api</a>
☕️ ☕️
&nbsp;7 min read
<time class="hidden dt-published">2020-11-10 04:52:50 -0500 -0500</time></p></li><li role=none class=h-entry><p class="p-author h-card hidden">Victoria Drake</p><img class="u-photo hidden" alt="photo of the author" id=author-img src=/img/victoria_headshot.jpg>
<a role=menuitem class="article-link u-url p-name" href=https://victoria.dev/blog/three-rules-for-choosing-a-vpn-that-takes-your-privacy-seriously/>Three rules for choosing a VPN that takes your privacy seriously</a><p class=e-content>The lesser-known risks of ISPs and why I chose ExpressVPN.</p><p class=metadata><a class="tag button" href=/tags/privacy/>privacy</a>
☕️ ☕️
&nbsp;6 min read
<time class="hidden dt-published">2020-10-18 04:41:37 -0400 -0400</time></p></li><li role=none class=h-entry><p class="p-author h-card hidden">Victoria Drake</p><img class="u-photo hidden" alt="photo of the author" id=author-img src=/img/victoria_headshot.jpg>
<a role=menuitem class="article-link u-url p-name" href=https://victoria.dev/blog/deceptively-simple-search-and-replace-across-multiple-files/>Deceptively simple search-and-replace across multiple files</a><p class=e-content>How to interactively search-and-replace across many files with just two commands, thanks to Vim.</p><p class=metadata><a class="tag button" href=/tags/terminal/>terminal</a>
☕️
&nbsp;2 min read
<time class="hidden dt-published">2020-08-25 04:48:39 -0600 -0600</time></p></li></ul><div class=page-separator><p class=back-link><a href=/blog>&lt;&lt; Back to blog</a></p></div></div></div><footer class=container><div class="markdown bio h-card p-author"><strong><a href=https://victoria.dev/ class="u-url p-name">Victoria Drake</a></strong><figure class="profile title-avatar u-photo"><img src=/img/victoria_headshot.jpg alt="Victoria's headshot"></figure><p>Victoria Drake is a Director of Engineering in Washington, DC. She is a core maintainer and co-author for the Open Web Application Security Project (OWASP) Web Security Testing Guide. She earned the annual Top Contributor award three years in a row from the freeCodeCamp non-profit, and was recognized two years in a row as a Distinguished Author on the DEV.to developer platform. She writes and educates programmers and business leaders about cybersecurity, software development, and building happy and productive technical teams.</p><p><a href=/about>about</a> - <a href=mailto:hello@victoria.dev>email</a> - <a href=https://github.com/victoriadrake>github</a> - <a href=https://twitter.com/victoriadotdev>twitter</a> - <a href=https://www.linkedin.com/in/victoriadotdev/>linkedin</a></p></div></footer></main><script src=/js/webmention.min.js data-wordcount=42 async></script><nav aria-label="Victoria.dev menu for mobile" id=menu-mobile><ul role=menubar><li role=none class=menu-item><a role=menuitem href=/><img src=/img/bookmark.svg alt="home page icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/blog/><img src=/img/quote.svg alt="blog icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/about/><img src=/img/profile.svg alt="about page icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/coffee/><img src=/img/coffee.svg alt="coffee icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/bookshelf/><img src=/img/book.svg alt="bookshelf icon" height=18px class=filter-icon></a></li></ul></nav></body></html>