<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="Victoria Drake is a software developer. She writes about cybersecurity, technology, coding, and becoming a happier and more efficient human."><title>A portable Makefile for continuous delivery with Hugo and GitHub Pages - victoria.dev</title><meta property="og:title" content="A portable Makefile for continuous delivery with Hugo and GitHub Pages - victoria.dev"><meta property="og:type" content="website"><meta property="og:description" content="My Makefile for building this site, optimizing images, and running my CI/CD GitHub Actions flow."><meta property="og:url" content="https://victoria.dev/blog/a-portable-makefile-for-continuous-delivery-with-hugo-and-github-pages/"><meta property="og:site_name" content="victoria.dev"><meta property="og:image" content="https://victoria.dev/blog/a-portable-makefile-for-continuous-delivery-with-hugo-and-github-pages/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="A portable Makefile for continuous delivery with Hugo and GitHub Pages"><meta name=twitter:image content="https://victoria.dev/blog/a-portable-makefile-for-continuous-delivery-with-hugo-and-github-pages/cover.png"><meta name=twitter:description content="My Makefile for building this site, optimizing images, and running my CI/CD GitHub Actions flow."><link rel="shortcut icon" href=/img/logo.ico><link rel=stylesheet href=/css/main.min.98f8f28905bd4fd2c603e60133527d304793e4b6bb5b9fc898125c74df442ca9.css integrity="sha256-mPjyiQW9T9LGA&#43;YBM1J9MEeT5La7W5/ImBJcdN9ELKk=" media=screen></head><body><section id=main><div class=header><div class=toggle><input type=checkbox>
<span class=bar></span><span class=bar></span><span class=bar></span><div id=mobile-menu><span class=menu-item><a href=/>üë©üèª‚Äçüíª hi</a></span>
<span class=menu-item><a href=/blog/>üì∞ blog</a></span>
<span class=menu-item><a href=/about/>üìñ readme</a></span>
<span class=menu-item><a href=/coffee/><img src=/coffee/cup.png alt="coffee icon" height=16px> contribute</a></span></div></div><div id=menu><span class=menu-item><a href=/>üë©üèª‚Äçüíª hi</a></span>
<span class=menu-item><a href=/blog/>üì∞ blog</a></span>
<span class=menu-item><a href=/about/>üìñ readme</a></span>
<span class=menu-item><a href=/coffee/><img src=/coffee/cup.png alt="coffee icon" height=16px> contribute</a></span></div><div id=logo><img id=up alt="site logo" src=/img/logo.png></div></div><div class=container><div id=images><img src=https://victoria.dev/blog/a-portable-makefile-for-continuous-delivery-with-hugo-and-github-pages/cover.png alt="cover image"></div><div class=markdown><h1>A portable Makefile for continuous delivery with Hugo and GitHub Pages</h1><p id=date>October 21, 2019 &#183; 5 min read
&nbsp;
<a class=tag href=/tags/coding/>coding
</a>&nbsp;
<a class=tag href=/tags/linux/>linux
</a>&nbsp;
<a class=tag href=/tags/terminal/>terminal
</a>&nbsp;
<a class=tag href=/tags/websites/>websites
</a>&nbsp;</p></div><div class=page-separator><hr></div><div class=markdown><p>Fun fact: I first launched this GitHub Pages site 1,018 days ago.</p><p>Since then, we&rsquo;ve grown together. From early cringe-worthy commit messages, through eighty-six versions of <a href=https://gohugo.io/>Hugo</a>, and up until last week, a less-than-streamlined multi-app continuous integration and deployment (CI/CD) workflow.</p><p>If you know me at all, you know I love to automate things. I&rsquo;ve been using a combination of AWS Lambda, Netlify, and Travis CI to automatically build and publish this site. My workflow for the task includes:</p><ul><li>Build with <a href=https://gohugo.io/>Hugo</a> on push to master, and on a schedule (Netlify and Lambda);</li><li>Optimize and resize images (Netlify);</li><li>Test with <a href=https://github.com/gjtorikian/html-proofer>HTMLProofer</a> (Travis CI); and</li><li>Deploy to my <a href=/blog/two-ways-to-deploy-a-public-github-pages-site-from-a-private-hugo-repository/>separate, public, GitHub Pages repository</a> (Netlify).</li></ul><p>Thanks to the introduction of GitHub Actions, I&rsquo;m able to do all the above with just one portable <a href=https://en.wikipedia.org/wiki/Makefile>Makefile</a>.</p><p>Next week I&rsquo;ll cover my Actions set up; today, I&rsquo;ll take you through the nitty-gritty of my Makefile so you can write your own.</p><h2 id=makefile-portability>Makefile portability</h2><p><a href=https://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html>POSIX-standard-flavour Make</a> runs on every Unix-like system out there. <a href=https://en.wikipedia.org/wiki/Make_(software)#Derivatives>Make derivatives</a>, such as <a href=https://www.gnu.org/software/make/>GNU Make</a> and several flavours of BSD Make also run on Unix-like systems, though their particular use requires installing the respective program. To write a truly portable Makefile, mine follows the POSIX standard. (For a more thorough summation of POSIX-compatible Makefiles, I found this article helpful: <a href=https://nullprogram.com/blog/2017/08/20/>A Tutorial on Portable Makefiles</a>.) I run Ubuntu, so I&rsquo;ve tested the portability aspect using the BSD Make programs <code>bmake</code>, <code>pmake</code>, and <code>fmake</code>. Compatibility with non-Unix-like systems is a little more complicated, since shell commands differ. With derivatives such as Nmake, it&rsquo;s better to write a separate Makefile with appropriate Windows commands.</p><p>While much of my particular use case could be achieved with shell scripting, I find Make offers some worthwhile advantages. I enjoy the ease of using variables and <a href=https://en.wikipedia.org/wiki/Make_(software)#Macros>macros</a>, and the modularity of <a href=https://en.wikipedia.org/wiki/Makefile#Rules>rules</a> when it comes to organizing my steps.</p><p>The writing of rules mostly comes down to shell commands, which is the main reason Makefiles are as portable as they are. The best part is that you can do pretty much <em>anything</em> in a terminal, and certainly handle all the workflow steps listed above.</p><h2 id=my-continuous-deployment-makefile>My continuous deployment Makefile</h2><p>Here&rsquo;s the portable Makefile that handles my workflow. Yes, I put emojis in there. I&rsquo;m a monster.</p><div class=highlight><pre class=chroma><code class=language-Makefile data-lang=Makefile><span class=nf>.POSIX</span><span class=o>:</span>
<span class=nv>DESTDIR</span><span class=o>=</span>public
<span class=nv>HUGO_VERSION</span><span class=o>=</span><span class=m>0</span>.58.3

<span class=nv>OPTIMIZE</span> <span class=o>=</span> find <span class=k>$(</span>DESTDIR<span class=k>)</span> -not -path <span class=s2>&#34;*/static/*&#34;</span> <span class=se>\(</span> -name <span class=s1>&#39;*.png&#39;</span> -o -name <span class=s1>&#39;*.jpg&#39;</span> -o -name <span class=s1>&#39;*.jpeg&#39;</span> <span class=se>\)</span> -print0 <span class=p>|</span> <span class=se>\
</span><span class=se></span><span class=err>xargs</span> <span class=err>-0</span> <span class=err>-P8</span> <span class=err>-n2</span> <span class=err>mogrify</span> <span class=err>-strip</span> <span class=err>-thumbnail</span> <span class=s1>&#39;1000&gt;&#39;</span>

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>all</span>
<span class=nf>all</span><span class=o>:</span> <span class=n>get_repository</span> <span class=n>clean</span> <span class=n>get</span> <span class=n>build</span> <span class=n>test</span> <span class=n>deploy</span>

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>get_repository</span>
<span class=nf>get_repository</span><span class=o>:</span>
	@echo <span class=s2>&#34;üõé Getting Pages repository&#34;</span>
	git clone https://github.com/victoriadrake/victoriadrake.github.io.git <span class=k>$(</span>DESTDIR<span class=k>)</span>

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span>
<span class=nf>clean</span><span class=o>:</span>
	@echo <span class=s2>&#34;üßπ Cleaning old build&#34;</span>
	<span class=nb>cd</span> <span class=k>$(</span>DESTDIR<span class=k>)</span> <span class=o>&amp;&amp;</span> rm -rf *

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>get</span>
<span class=nf>get</span><span class=o>:</span>
	@echo <span class=s2>&#34;‚ùì Checking for hugo&#34;</span>
	@if ! <span class=o>[</span> -x <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>(command -v hugo)&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span><span class=se>\
</span><span class=se></span>		<span class=nb>echo</span> <span class=s2>&#34;ü§µ Getting Hugo&#34;</span><span class=p>;</span><span class=se>\
</span><span class=se></span>	    wget -q -P tmp/ https://github.com/gohugoio/hugo/releases/download/v<span class=k>$(</span>HUGO_VERSION<span class=k>)</span>/hugo_extended_<span class=k>$(</span>HUGO_VERSION<span class=k>)</span>_Linux-64bit.tar.gz<span class=p>;</span><span class=se>\
</span><span class=se></span>		tar xf tmp/hugo_extended_<span class=k>$(</span>HUGO_VERSION<span class=k>)</span>_Linux-64bit.tar.gz -C tmp/<span class=p>;</span><span class=se>\
</span><span class=se></span>		sudo mv -f tmp/hugo /usr/bin/<span class=p>;</span><span class=se>\
</span><span class=se></span>		rm -rf tmp/<span class=p>;</span><span class=se>\
</span><span class=se></span>		hugo version<span class=p>;</span><span class=se>\
</span><span class=se></span>	<span class=k>fi</span>

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>build</span>
<span class=nf>build</span><span class=o>:</span>
	@echo <span class=s2>&#34;üç≥ Generating site&#34;</span>
	hugo --gc --minify -d <span class=k>$(</span>DESTDIR<span class=k>)</span>

	@echo <span class=s2>&#34;üßÇ Optimizing images&#34;</span>
	<span class=k>$(</span>OPTIMIZE<span class=k>)</span>

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>test</span>
<span class=nf>test</span><span class=o>:</span>
	@echo <span class=s2>&#34;üçú Testing HTML&#34;</span>
	docker run -v <span class=k>$(</span>GITHUB_WORKSPACE<span class=k>)</span>/<span class=k>$(</span>DESTDIR<span class=k>)</span>/:/mnt 18fgsa/html-proofer mnt --disable-external

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>deploy</span>
<span class=nf>deploy</span><span class=o>:</span>
	@echo <span class=s2>&#34;üéÅ Preparing commit&#34;</span>
	@cd <span class=k>$(</span>DESTDIR<span class=k>)</span> <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> git config user.email <span class=s2>&#34;hello@victoria.dev&#34;</span> <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> git config user.name <span class=s2>&#34;Victoria via GitHub Actions&#34;</span> <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> git add . <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> git status <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> git commit -m <span class=s2>&#34;ü§ñ CD bot is helping&#34;</span> <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> git push -f -q https://<span class=k>$(</span>TOKEN<span class=k>)</span>@github.com/victoriadrake/victoriadrake.github.io.git master
	@echo <span class=s2>&#34;üöÄ Site is deployed!&#34;</span>
</code></pre></div><p>Sequentially, this workflow:</p><ol><li>Clones the public Pages repository;</li><li>Cleans (deletes) the previous build files;</li><li>Downloads and installs the specified version of Hugo, if Hugo is not already present;</li><li>Builds the site;</li><li>Optimizes images;</li><li>Tests the built site with HTMLProofer, and</li><li>Prepares a new commit and pushes to the public Pages repository.</li></ol><p>If you&rsquo;re familiar with command line, most of this may look familiar. Here are a couple bits that might warrant a little explanation.</p><h3 id=checking-if-a-program-is-already-installed>Checking if a program is already installed</h3><p>I think this bit is pretty tidy:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=k>if</span> ! <span class=o>[</span> -x <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>(command -v hugo)&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span><span class=se>\
</span><span class=se></span>...
<span class=k>fi</span></code></pre></div><p>I use a negated <code>if</code> conditional in conjunction with <code>command -v</code> to check if an executable (<code>-x</code>) called <code>hugo</code> exists. If one is not present, the script gets the specified version of Hugo and installs it. <a href=https://stackoverflow.com/a/677212>This Stack Overflow answer</a> has a nice summation of why <code>command -v</code> is a more portable choice than <code>which</code>.</p><h3 id=image-optimization>Image optimization</h3><p>My Makefile uses <code>mogrify</code> to batch resize and compress images in particular folders. It finds them automatically using the file extension, and only modifies images that are larger than the target size of 1000px in any dimension. I wrote more about the <a href=/blog/how-to-quickly-batch-resize-compress-and-convert-images-with-a-bash-one-liner/>batch-processing one-liner in this post</a>.</p><p>There are a few different ways to achieve this same task, one of which, theoretically, is to take advantage of Make&rsquo;s <a href=https://en.wikipedia.org/wiki/Make_(software)#Suffix_rules>suffix rules</a> to run commands only on image files. I find the shell script to be more readable.</p><h3 id=using-dockerized-htmlproofer>Using Dockerized HTMLProofer</h3><p>HTMLProofer is installed with <code>gem</code>, and uses Ruby and <a href=https://nokogiri.org/tutorials/ensuring_well_formed_markup.html>Nokogiri</a>, which adds up to a lot of installation time for a CI workflow. Thankfully, <a href=https://github.com/18F>18F</a> has a <a href=https://github.com/18F/html-proofer-docker>Dockerized version</a> that is much faster to implement. Its usage requires starting the container with the built site directory <a href=https://docs.docker.com/storage/volumes/#start-a-container-with-a-volume>mounted as a data volume</a>, which is easily achieved by appending to the <code>docker run</code> command.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>docker run -v /absolute/path/to/site/:/mounted-site 18fgsa/html-proofer /mounted-site</code></pre></div><p>In my Makefile, I specify the absolute site path using the <a href=https://help.github.com/en/articles/virtual-environments-for-github-actions#environment-variables>default environment variable</a> <code>GITHUB_WORKSPACE</code>. I&rsquo;ll dive into this and other GitHub Actions features in the next post.</p><p>In the meantime, happy Making!</p></div><div class=page-separator><hr></div><div class=related><h3>An algorithm thinks these posts are related...</h3><ul id=list-items><li><a class=li-tag href=/tags/coding/>coding</a>
<a class=li-link href=https://victoria.dev/blog/a-lightweight-tool-agnostic-ci/cd-flow-with-github-actions/>A lightweight, tool-agnostic CI/CD flow with GitHub Actions</a></li><li><a class=li-tag href=/tags/websites/>websites</a>
<a class=li-link href=https://victoria.dev/blog/a-quick-guide-to-changing-your-github-username/>A quick guide to changing your GitHub username</a></li><li><a class=li-tag href=/tags/coding/>coding</a>
<a class=li-link href=https://victoria.dev/blog/how-to-print-newlines-in-command-line-output/>How to print newlines in command line output</a></li></ul><div class=page-separator><p class=back-link><a href=/blog>&lt;&lt; Back to blog</a></p></div></div></div><div class=container><footer><div class=markdown><p><img src=/img/victoria_headshot.jpg#profile alt="Victoria's headshot"></p><p>Victoria Drake is a developer and security enthusiast in Washington, DC. She writes technical articles about software development and cybersecurity. She is an author of the OWASP Web Security Testing Guide, a two-time award-winning contributor to freeCodeCamp, and a project leader in GitHub&rsquo;s open source community.</p><p><a href=/about>about</a> - <a href=mailto:hello@victoria.dev>email</a> - <a href=https://github.com/victoriadrake>github</a> - <a href=https://twitter.com/victoriadotdev>twitter</a></p></div></footer></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-98623582-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>scrollTo=(element)=>{window.scroll({behavior:'smooth',left:0,top:element.offsetTop});}
document.getElementById("up").addEventListener('click',()=>{scrollTo(document.getElementById("main"));});</script></body></html>