<!doctype html><html lang=en-us><head><head><meta charset=utf-8><meta name=mobile-web-app-capable content="yes"><meta name=viewport content="width=device-width,initial-scale=1"><title>victoria.dev</title><meta name=monetization content="$ilp.uphold.com/pBRfRwg2EJAe"><link rel="shortcut icon" href=https://victoria.dev/favicon.ico><link rel=icon type=image/png href=https://victoria.dev/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://victoria.dev/favicon-16x16.png sizes=16x16><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=me href=https://github.com/victoriadrake><link rel=me href=https://twitter.com/victoriadotdev><link rel=me href=https://mastodon.technology/@victoria><link rel=stylesheet href=https://victoria.dev/css/style.css crossorigin=anonymous media=screen><link rel=webmention href=https://webmention.io/victoria.dev/webmention><link rel=pingback href=https://webmention.io/victoria.dev/xmlrpc><meta property="og:url" content="https://victoria.dev/"><meta property="og:title" content="victoria.dev"><meta property="og:site_name" content="victoria.dev"><meta property="og:type" content="website"><meta name=twitter:title content="victoria.dev"></head></head><body><header role=banner><nav aria-label="Victoria.dev main menu" id=menu><ul role=menubar><li role=none class=menu-item><a role=menuitem href=/><img src=/icon/bookmark.svg alt="home page icon" height=18px class=filter-icon>&nbsp;hello</a></li><li role=none class=menu-item><a role=menuitem href=/blog/><img src=/icon/quote.svg alt="blog icon" height=18px class=filter-icon>&nbsp;blog</a></li><li role=none class=menu-item><a role=menuitem href=/about/><img src=/icon/profile.svg alt="about page icon" height=18px class=filter-icon>&nbsp;about</a></li><li role=none class=menu-item><a role=menuitem href=/bookshelf/><img src=/icon/book.svg alt="bookshelf icon" height=18px class=filter-icon>&nbsp;bookshelf</a></li></ul></nav><nav aria-label="Victoria.dev menu for mobile" id=menu-mobile><ul role=menubar><li role=none class=menu-item><a role=menuitem href=/><img src=/icon/bookmark.svg alt="home page icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/blog/><img src=/icon/quote.svg alt="blog icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/about/><img src=/icon/profile.svg alt="about page icon" height=18px class=filter-icon></a></li><li role=none class=menu-item><a role=menuitem href=/bookshelf/><img src=/icon/book.svg alt="bookshelf icon" height=18px class=filter-icon></a></li></ul></nav></header><main aria-role=main><div class=container><div id=cover-image><img class=u-photo src=https://victoria.dev/blog/manipulating-data-with-django-migrations/cover.png alt="cover image"></div><article class=h-entry><h1 class=p-name>Manipulating data with Django migrations</h1><p class=subtitle>How to update Django models and manipulate existing data using migrations.</p><span><a class="p-category tag button" href=/tags/coding/>coding
</a>&nbsp;
<a class="p-category tag button" href=/tags/data/>data
</a>&nbsp;
<a class="p-category tag button" href=/tags/python/>python
</a>&nbsp;</span>
<span rel=author class="p-author h-card"><img class="u-photo hidden" src=/img/victoria_headshot.jpg>
<span class="p-name hidden" rel=me>Victoria Drake</span></span><p class=metadata id=date><time class="hidden dt-published">2020-09-14 02:12:57 -0400 -0400</time>
<a class=u-url href=https://victoria.dev/blog/manipulating-data-with-django-migrations/>September 14, 2020</a>
<span class=dt-updated>&nbsp;<em>Updated: Jun 8, 2021</em></span>
<span>&nbsp;5 min read</span></p></p><div class=page-separator><hr></div><div class="markdown e-content"><p>Growing, successful applications are a lovely problem to have. As a product develops, it tends to accumulate complication the way your weekend cake project accumulates layers of frosting. Thankfully, Django, my favorite batteries-included framework, handles complexity pretty well.</p><p>Django <a href=/blog/writing-efficient-django/#django-models>models help humans work with data in a way that makes sense to our brains</a>, and the framework offers plenty of classes you can inherit to help you rapidly develop a robust application from scratch. As for developing on existing Django applications, there&rsquo;s a feature for that, too. In this article, we&rsquo;ll cover how to use Django migrations to update your existing models and database.</p><h2 id=whats-under-the-hood>What&rsquo;s under the hood</h2><p>Django migrations are Python files that help you add and change things in your database tables to reflect changes in your Django models. To understand how Django migrations help you work with data, it may be helpful to understand the underlying structures we&rsquo;re working with.</p><h3 id=whats-a-database-table>What&rsquo;s a database table</h3><p>If you&rsquo;ve laid eyes on a spreadsheet before, you&rsquo;re already most of the way to understanding a database table. In a relational database, for example, a PostgreSQL database, you can expect to see data organized into columns and rows. A relational database table may have a set number of columns and any number of rows.</p><p>In Django, each model is its own table. For example, here&rsquo;s a Django model:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>


<span class=k>class</span> <span class=nc>Lunch</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>left_side</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>right_side</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</code></pre></div><p>Each field is a column, and each row is a Django object instance of that model. Here&rsquo;s a representation of a database table for the Django model &ldquo;Lunch&rdquo; above. In the database, its name would be <code>lunch_table</code>.</p><table><thead><tr><th>id</th><th>left_side</th><th>center</th><th>right_side</th></tr></thead><tbody><tr><td>1</td><td>Fork</td><td>Plate</td><td>Spoon</td></tr></tbody></table><p>The model <code>Lunch</code> has three fields: <code>left_side</code>, <code>center</code>, and <code>right-side</code>. One instance of a <code>Lunch</code> object would have &ldquo;Fork&rdquo; for the <code>left_side</code>, a &ldquo;Plate&rdquo; for the <code>center</code>, and &ldquo;Spoon&rdquo; for the <code>right_side</code>. Django <a href=https://docs.djangoproject.com/en/3.1/topics/db/models/#automatic-primary-key-fields>automatically adds an <code>id</code> field</a> if you don&rsquo;t specify a primary key.</p><p>If you wanted to change the name of your Lunch model, you would do so in your <code>models.py</code> code. For example, change &ldquo;Lunch&rdquo; to &ldquo;Dinner,&rdquo; then <a href=https://docs.djangoproject.com/en/3.1/ref/django-admin/#makemigrations>run <code>python manage.py makemigrations</code></a>. You&rsquo;ll see:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>python manage.py makemigrations
Did you rename the backend.Lunch model to Dinner? [y/N] y
Migrations for &#39;backend&#39;:
  backend/migrations/0003_auto_20200922_2331.py
    - Rename model Lunch to Dinner
</code></pre></div><p>Django automatically generates the appropriate migration files. The relevant line of the generated migrations file in this case would look like:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>migrations</span><span class=o>.</span><span class=n>RenameModel</span><span class=p>(</span><span class=n>old_name</span><span class=o>=</span><span class=s2>&#34;Lunch&#34;</span><span class=p>,</span> <span class=n>new_name</span><span class=o>=</span><span class=s2>&#34;Dinner&#34;</span><span class=p>),</span>
</code></pre></div><p>This operation would rename our &ldquo;Lunch&rdquo; model to &ldquo;Dinner&rdquo; while keeping everything else the same. But what if you also wanted to change the structure of the database table itself, its schema, as well as make sure that existing data ends up in the right place on your Dinner table?</p><p>Let&rsquo;s explore how to turn our Lunch model into a Dinner model that looks like this:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>


<span class=k>class</span> <span class=nc>Dinner</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>top_left</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>top_center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>top_right</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_left</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_right</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</code></pre></div><p>&mldr;with a database table that would look like this:</p><table><thead><tr><th>id</th><th>top_left</th><th>top_center</th><th>top_right</th><th>bottom_left</th><th>bottom_center</th><th>bottom_right</th></tr></thead><tbody><tr><td>1</td><td>Bread plate</td><td>Spoon</td><td>Glass</td><td>Fork</td><td>Plate</td><td>Knife</td></tr></tbody></table><h2 id=manipulating-data-with-django-migrations>Manipulating data with Django migrations</h2><p>Before you begin to manipulate your data, it&rsquo;s always a good idea to create a backup of your database that you can restore in case something goes wrong. There are various ways to do this depending on the database you&rsquo;re using. You can typically find instructions by searching for <code>&lt;your database name></code> and keywords like <code>backup</code>, <code>recovery</code>, or <code>snapshot</code>.</p><p>In order to design your migration, it&rsquo;s helpful to become familiar with the available <a href=https://docs.djangoproject.com/en/3.1/ref/migration-operations/>migration operations</a>. Migrations are run step-by-step, and each operation is some flavor of adding, removing, or altering data. Like a strategic puzzle, it&rsquo;s important to make model changes one step at a time so that the generated migrations have the correct result.</p><p>We&rsquo;ve already renamed our model successfully. Now, we&rsquo;ll rename the fields that hold the data we want to retain:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Dinner</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>bottom_left</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>top_center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</code></pre></div><p>Django is sometimes smart enough to determine the old and new field names correctly. You&rsquo;ll be asked for confirmation:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>python manage.py makemigrations
Did you rename dinner.center to dinner.bottom_center (a CharField)? [y/N] y
Did you rename dinner.left_side to dinner.bottom_left (a CharField)? [y/N] y
Did you rename dinner.right_side to dinner.top_center (a CharField)? [y/N] y
Migrations for &#39;backend&#39;:
  backend/migrations/0004_auto_20200914_2345.py
    - Rename field center on dinner to bottom_center
    - Rename field left_side on dinner to bottom_left
    - Rename field right_side on dinner to top_center
</code></pre></div><p>In some cases, you&rsquo;ll want to try renaming the field and running <code>makemigrations</code> one at a time.</p><p>Now that the existing fields have been migrated to their new names, add the remaining fields to the model:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Dinner</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>top_left</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>top_center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>top_right</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_left</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_center</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>bottom_right</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</code></pre></div><p>Running <code>makemigrations</code> again now gives us:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>python manage.py makemigrations
Migrations for &#39;backend&#39;:
  backend/migrations/0005_auto_20200914_2351.py
    - Add field bottom_right to dinner
    - Add field top_left to dinner
    - Add field top_right to dinner
</code></pre></div><p>You&rsquo;re done! By generating Django migrations, you&rsquo;ve successfully set up your <code>dinner_table</code> and moved existing data to its new spot.</p><h2 id=additional-complexity>Additional complexity</h2><p>You&rsquo;ll notice that our Lunch and Dinner models are not very complex. Out of Django&rsquo;s many <a href=https://docs.djangoproject.com/en/3.1/ref/models/fields/#field-types>model field options</a>, we&rsquo;re just using <code>CharField</code>. We also set <code>null=True</code> to let Django store empty values as <code>NULL</code> in the database.</p><p>Django migrations can handle additional complexity, such as changing field types, and whether a blank or null value is permitted. I keep Django&rsquo;s <a href=https://docs.djangoproject.com/en/3.1/ref/models/fields/#>model field reference</a> handy as I work with varying types of data and different use cases.</p><h2 id=de-mystified-migrations>De-mystified migrations</h2><p>I hope this article has helped you better understand Django migrations and how they work!</p><p>Now that you can change models and manipulate existing data in your Django application, be sure to use your powers wisely! Backup your database, research and plan your migrations, and always run tests before working with customer data. By doing so, you have the potential to enable your application to grow &ndash; with manageable levels of complexity.</p></div><a class=hidden href=https://brid.gy/publish/twitter></a><a class=hidden href=https://brid.gy/publish/mastodon></a><data class=p-bridgy-omit-link value=false></data></article><div id=up-container><a href=# id=up>v</a></div><hr><div id=webmentions></div><div class=related><code class=language-sql data-lang=sql>SELECT TOP 3 * FROM Related;</code><ul role=menubar id=article-list><li role=none class=h-entry><a rel=author class="p-author h-card hidden" href=https://victoria.dev/>Victoria Drake</a>
<a role=menuitem class="article-link u-url p-name" href=https://victoria.dev/blog/build-your-own-serverless-subscriber-list-with-go-and-aws/>Build your own serverless subscriber list with Go and AWS</a><p class="p-summary e-content">How to build your own newsletter list with DynamoDB and SES email sign up confirmations.</p><p class=metadata><a class="p-category tag button" href=https://victoria.dev/tags/api/>api</a>
&nbsp;7 min read
<time class="hidden dt-published">2020-11-10 04:52:50 -0500 -0500</time></p></li><li role=none class=h-entry><a rel=author class="p-author h-card hidden" href=https://victoria.dev/>Victoria Drake</a>
<a role=menuitem class="article-link u-url p-name" href=https://victoria.dev/blog/increase-developer-confidence-with-a-great-django-test-suite/>Increase developer confidence with a great Django test suite</a><p class="p-summary e-content">How to write tests for your Django applications that boost your team, and are actually useful.</p><p class=metadata><a class="p-category tag button" href=https://victoria.dev/tags/coding/>coding</a>
&nbsp;5 min read
<time class="hidden dt-published">2020-10-01 05:50:37 -0400 -0400</time></p></li><li role=none class=h-entry><a rel=author class="p-author h-card hidden" href=https://victoria.dev/>Victoria Drake</a>
<a role=menuitem class="article-link u-url p-name" href=https://victoria.dev/blog/django-project-best-practices-to-keep-your-developers-happy/>Django project best practices to keep your developers happy</a><p class="p-summary e-content">Using Makefiles, pre-commit, and GitHub Actions to help create a happy development team.</p><p class=metadata><a class="p-category tag button" href=https://victoria.dev/tags/python/>python</a>
&nbsp;6 min read
<time class="hidden dt-published">2020-09-22 04:55:19 -0400 -0400</time></p></li></ul><div class=page-separator><p class=back-link><a href=/blog>&lt;&lt; Back to blog</a></p></div></div></div></main><footer><div class="h-card row bio" rel=author><div class=markdown id=card><figure class=profile><img class=u-photo alt="Victoria Drake" src=/img/victoria_headshot.jpg></figure><h1 class=p-name>Victoria Drake</h1></address><p class=p-note><p>Victoria Drake is a Director of Engineering in Washington, DC. She is a core maintainer and co-author for the Open Web Application Security Project (OWASP) Web Security Testing Guide. She earned the annual Top Contributor award three years in a row from the freeCodeCamp non-profit, and was recognized two years in a row as a Distinguished Author on the DEV.to developer platform. She writes and educates programmers and business leaders about cybersecurity, software development, and building happy and productive technical teams.</p><p><a href=/about>about</a> - <a href=/contact>contact</a> - <a href=https://github.com/victoriadrake>github</a> - <a href=https://twitter.com/victoriadotdev>twitter</a> - <a href=https://www.linkedin.com/in/victoriadotdev/>linkedin</a></p></p></div></div></footer><script src=/js/webmention.min.js data-wordcount=100 async></script></body></html>